<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Basic Colors NFT Viewer</title>
  <!-- Ethers.js v5 from a CDN -->
  <script src="https://cdn.ethers.io/scripts/ethers-v5.min.js" type="application/javascript"></script>
  <style>
    body {
      font-family: sans-serif;
      margin: 1rem;
    }
    #gallery {
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
      margin-top: 1rem;
    }
    .nft-card {
      border: 1px solid #ccc;
      padding: 0.5rem;
      text-align: center;
    }
    .nft-card img {
      max-width: 200px;
      max-height: 200px;
      display: block;
      margin: 0 auto;
    }
  </style>
</head>
<body>
  <h1>Basic Colors NFT</h1>

  <button id="connectBtn">Connect Wallet</button>
  <button id="mintBtn" disabled>Mint NFT</button>
  <button id="refreshBtn" disabled>Refresh Gallery</button>
  <p id="status"></p>

  <!-- Gallery container to show minted NFTs -->
  <div id="gallery"></div>

  <script>
    /*************************************************************
     *                  CONTRACT CONFIGURATION
     *************************************************************/
    const CONTRACT_ADDRESS = "0x5Fdda3D8Aa057B858a1F45642C29E93beed86742";
    // Minimal ABI with mint, totalSupply, and tokenURI
    const ABI = [
      "function mint() external",
      "function totalSupply() public view returns (uint256)",
      "function tokenURI(uint256) public view returns (string memory)"
    ];

    let provider, signer, contract;

    // DOM elements
    const connectBtn = document.getElementById("connectBtn");
    const mintBtn = document.getElementById("mintBtn");
    const refreshBtn = document.getElementById("refreshBtn");
    const statusEl = document.getElementById("status");
    const galleryEl = document.getElementById("gallery");

    // Wire up event listeners
    connectBtn.onclick = connectWallet;
    mintBtn.onclick = mintNFT;
    refreshBtn.onclick = fetchAllNFTs;

    /*************************************************************
     *                     CONNECT WALLET
     *************************************************************/
    async function connectWallet() {
      if (typeof window.ethereum === "undefined") {
        statusEl.textContent = "MetaMask is not installed.";
        return;
      }
      try {
        await window.ethereum.request({ method: "eth_requestAccounts" });
        provider = new ethers.providers.Web3Provider(window.ethereum, "any");
        signer = provider.getSigner();

        // Instantiate contract
        contract = new ethers.Contract(CONTRACT_ADDRESS, ABI, signer);

        // Enable the buttons now that we're connected
        mintBtn.disabled = false;
        refreshBtn.disabled = false;
        statusEl.textContent = "Wallet connected!";

        // Optionally auto-fetch on connect
        fetchAllNFTs();
      } catch (error) {
        statusEl.textContent = "Error connecting wallet: " + error.message;
      }
    }

    /*************************************************************
     *                        MINT NFT
     *************************************************************/
    async function mintNFT() {
      if (!contract) {
        statusEl.textContent = "Please connect wallet first.";
        return;
      }
      try {
        statusEl.textContent = "Minting... please confirm transaction in MetaMask.";
        const tx = await contract.mint();
        statusEl.textContent = "Transaction submitted: " + tx.hash;

        await tx.wait();
        statusEl.textContent = "Mint successful! Token minted. Tx: " + tx.hash;

        // Fetch gallery again to include the new NFT
        fetchAllNFTs();
      } catch (error) {
        console.error(error);
        statusEl.textContent = "Mint error: " + (error.message || error);
      }
    }

    /*************************************************************
     *                FETCH ALL MINTED NFTs
     *************************************************************/
    async function fetchAllNFTs() {
      if (!contract) {
        statusEl.textContent = "Connect wallet to fetch NFTs.";
        return;
      }
      statusEl.textContent = "Fetching all NFTs...";

      try {
        // 1) Get total supply (number of minted tokens)
        const supply = await contract.totalSupply();
        const total = supply.toNumber();

        // 2) Clear existing gallery
        galleryEl.innerHTML = "";

        // 3) Loop over each token ID and fetch its tokenURI
        for (let tokenId = 0; tokenId < total; tokenId++) {
          const uri = await contract.tokenURI(tokenId);
          // This is a data: URI with base64-encoded JSON. e.g., "data:application/json;base64,eyJ..."
          // We need to decode the base64-encoded JSON to extract image, name, description, etc.

          const metadata = decodeDataURI(uri);
          // metadata.image should be "data:image/svg+xml;base64,..." or similar

          // Create an element in the gallery
          const card = document.createElement("div");
          card.className = "nft-card";

          // The image
          const img = document.createElement("img");
          img.src = metadata.image; // It's already a data URI
          card.appendChild(img);

          // A simple label
          const label = document.createElement("p");
          label.textContent = `Token #${tokenId} - ${metadata.name || ""}`;
          card.appendChild(label);

          galleryEl.appendChild(card);
        }

        statusEl.textContent = `Fetched ${total} NFT(s).`;
      } catch (error) {
        console.error(error);
        statusEl.textContent = "Error fetching NFTs: " + (error.message || error);
      }
    }

    /*************************************************************
     *        HELPER: Decode Base64-Encoded JSON data URI
     *************************************************************/
    function decodeDataURI(dataURI) {
      // Format: "data:application/json;base64,eyJ..."
      const base64Part = dataURI.split(",")[1];
      const jsonString = atob(base64Part);
      return JSON.parse(jsonString);
    }
  </script>
</body>
</html>

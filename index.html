<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>BitTensor Testnet PLY + Mint Example</title>

  <!-- Three.js -->
  <script src="https://unpkg.com/three@latest/build/three.min.js"></script>
  <!-- PLYLoader (from three/examples) -->
  <script src="https://unpkg.com/three@latest/examples/js/loaders/PLYLoader.js"></script>
  <!-- Ethers.js v5 -->
  <script src="https://cdn.ethers.io/scripts/ethers-v5.min.js" type="application/javascript"></script>

  <style>
    body {
      margin: 0;
      overflow: hidden;
      font-family: sans-serif;
    }
    #scene-container {
      width: 100vw;
      height: 80vh;
      display: block;
    }
    #controls {
      margin: 0;
      padding: 1rem;
      background-color: #f4f4f4;
    }
    button {
      padding: 0.5rem 1rem;
      font-size: 1rem;
      margin-right: 1rem;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <!-- The 3D scene container -->
  <div id="scene-container"></div>

  <!-- Controls / Buttons -->
  <div id="controls">
    <button id="connectButton">Connect Wallet</button>
    <button id="mintButton" disabled>Mint NFT</button>
    <span id="status"></span>
  </div>

<script>
  /*************************************************************
   *               THREE.JS + PLY LOADING SECTION
   *************************************************************/

  // IPFS-hosted PLY file
  // (Replace with your own IPFS Gateway URL if different)
  const plyUrl = "https://orange-adverse-wolf-158.mypinata.cloud/ipfs/bafybeiedyzmedvrq27qwqcacyby2vsklqfx3nfnfm4kug4tauvpjimxj6a";

  let container, camera, scene, renderer;

  init3D();
  animate();

  function init3D() {
    container = document.getElementById('scene-container');

    // Create a PerspectiveCamera
    camera = new THREE.PerspectiveCamera(
      45,
      container.clientWidth / container.clientHeight,
      0.1,
      1000
    );
    camera.position.set(0, 0, 2);

    // Create the scene
    scene = new THREE.Scene();

    // Basic directional light
    const light = new THREE.DirectionalLight(0xffffff, 1);
    light.position.set(2, 2, 5).normalize();
    scene.add(light);

    // Renderer
    renderer = new THREE.WebGLRenderer({ antialias: true });
    renderer.setSize(container.clientWidth, container.clientHeight);
    container.appendChild(renderer.domElement);

    // Load PLY
    const loader = new THREE.PLYLoader();
    loader.load(
      plyUrl,
      function (geometry) {
        geometry.computeVertexNormals(); // for shading

        const material = new THREE.MeshStandardMaterial({
          color: 0x0055ff,
          flatShading: false,
        });

        const mesh = new THREE.Mesh(geometry, material);
        scene.add(mesh);
      },
      (xhr) => {
        console.log((xhr.loaded / xhr.total) * 100 + '% loaded');
      },
      (error) => {
        console.error('Error loading PLY:', error);
      }
    );
  }

  function animate() {
    requestAnimationFrame(animate);
    renderer.render(scene, camera);
  }

  // Handle window resize
  window.addEventListener('resize', onWindowResize);
  function onWindowResize() {
    camera.aspect = container.clientWidth / container.clientHeight;
    camera.updateProjectionMatrix();
    renderer.setSize(container.clientWidth, container.clientHeight);
  }

  /*************************************************************
   *                  WEB3 / ETHERS SECTION
   *************************************************************/
  
  // The address of your deployed BasicColorsNFT on BitTensor testnet
  const CONTRACT_ADDRESS = "0x5Fdda3D8Aa057B858a1F45642C29E93beed86742";
  // Minimal ABI with the mint() function
  const CONTRACT_ABI = [
    "function mint() external"
  ];

  // DOM elements
  const connectButton = document.getElementById("connectButton");
  const mintButton = document.getElementById("mintButton");
  const statusEl = document.getElementById("status");

  let provider;
  let signer;
  let contract;

  connectButton.addEventListener("click", connectWallet);
  mintButton.addEventListener("click", mintNFT);

  async function connectWallet() {
    if (typeof window.ethereum === "undefined") {
      statusEl.textContent = "MetaMask is not installed!";
      return;
    }

    try {
      // Request account access
      await window.ethereum.request({ method: "eth_requestAccounts" });

      // Create an Ethers provider and signer from MetaMask
      provider = new ethers.providers.Web3Provider(window.ethereum, "any");
      signer = provider.getSigner();

      // (Optional) Check if the user is on the correct chain
      // For BitTensor testnet, you'd confirm chainId, but some custom chains
      // might show up as '0xNaN' or need manual addition in MetaMask
      const network = await provider.getNetwork();
      console.log("Connected to chainId:", network.chainId);

      statusEl.textContent = "Wallet connected!";
      mintButton.disabled = false; // enable mint button once connected

      // Instantiate contract
      contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, signer);

    } catch (err) {
      console.error(err);
      statusEl.textContent = "User denied account access or error occurred";
    }
  }

  async function mintNFT() {
    if (!contract) {
      statusEl.textContent = "Connect wallet first!";
      return;
    }

    statusEl.textContent = "Minting... please wait.";
    try {
      const tx = await contract.mint();
      console.log("Transaction sent:", tx.hash);

      statusEl.textContent = "Transaction sent. Waiting for confirmation...";
      const receipt = await tx.wait();
      console.log("Transaction confirmed:", receipt);

      statusEl.textContent = `Mint successful! Tx Hash: ${tx.hash}`;
    } catch (err) {
      console.error(err);
      statusEl.textContent = `Error: ${err.message || err.toString()}`;
    }
  }
</script>
</body>
</html>
